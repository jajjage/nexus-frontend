# Two-Factor Authentication (2FA) Implementation Guide

This guide details the integration of Two-Factor Authentication (2FA) using Time-based One-Time Passwords (TOTP) for both User Self-Service and Admin Management.

## ðŸ›¡ï¸ Security Principles

- **Secret Management:** Secrets are generated securely on the server and never stored in plain text after initial display.
- **Verification:** 2FA is NOT enabled until the user successfully verifies a code generated by their authenticator app.
- **Backup Codes:** Emergency codes are provided upon successful setup.
- **Privilege Separation:** Users manage their own 2FA. Admins can initiate setup or reset 2FA for users but cannot "approve" it on behalf of the user (as that requires the physical device).

---

## ðŸ‘¤ User Self-Service Flow

### 1. Initiate Setup

**Endpoint:** `POST /api/v1/2fa/setup`
**Auth:** Required
**Response:**

```json
{
  "status": "success",
  "data": {
    "secret": "BASE32SECRET...",
    "qrCode": "data:image/png;base64,..."
  }
}
```

**Frontend Action:**

1.  Display the QR Code to the user.
2.  Ask user to scan it with Google Authenticator / Authy.
3.  Ask user to enter the 6-digit code to confirm.

### 2. Verify & Enable

**Endpoint:** `POST /api/v1/2fa/enable`
**Auth:** Required
**Body:** `{ "totpCode": "123456" }`
**Response:**

```json
{
  "status": "success",
  "data": {
    "backupCodes": ["CODE1", "CODE2", ...]
  }
}
```

**Frontend Action:**

1.  User enters code.
2.  If success, **display backup codes immediately**. Warn user to save them.
3.  Update UI to show "2FA Enabled".

### 3. Login with 2FA

**Flow:**

1.  `POST /api/v1/auth/login`.
2.  Server returns `403 Forbidden` (or specific 2FA required status) if 2FA is enabled but not verified in this session.
3.  **Endpoint:** `POST /api/v1/2fa/verify`
    - **Body:** `{ "totpCode": "123456" }` (or `"backupCode"`)
4.  Server issues full session token.

### 4. Disable 2FA

**Endpoint:** `POST /api/v1/2fa/disable`
**Auth:** Required

---

## ðŸ‘® Admin Management Flow

Admins can assist users who have lost access to their devices or need initial setup assistance.

### 1. Admin Initiates Setup

**Endpoint:** `POST /api/v1/admin/users/{userId}/2fa/setup`
**Auth:** Admin Role
**Response:**

```json
{
  "status": "success",
  "data": {
    "secret": "...",
    "qrCode": "...",
    "backupCodes": [...]
  }
}
```

**Use Case:** Admin is onboarding a user manually or setting up a company device. Admin displays QR code to user or configures device.

### 2. Admin Resets (Disables) 2FA

**Endpoint:** `POST /api/v1/admin/users/{userId}/2fa/disable`
**Auth:** Admin Role
**Use Case:** User lost phone and backup codes. Admin disables 2FA so user can log in and set it up again.

---

## ðŸ’» Frontend Integration (React Example)

```typescript
const Setup2FA = () => {
  const [qrCode, setQrCode] = useState(null);
  const [code, setCode] = useState("");

  const startSetup = async () => {
    const res = await api.post('/2fa/setup');
    setQrCode(res.data.qrCode);
  };

  const enable = async () => {
    try {
      const res = await api.post('/2fa/enable', { totpCode: code });
      alert("Success! Save these codes: " + res.data.backupCodes.join(", "));
    } catch (e) {
      alert("Invalid code");
    }
  };

  return (
    <div>
      {!qrCode ? (
        <button onClick={startSetup}>Enable 2FA</button>
      ) : (
        <>
          <img src={qrCode} alt="Scan me" />
          <input value={code} onChange={e => setCode(e.target.value)} />
          <button onClick={enable}>Verify</button>
        </>
      )}
    </div>
  );
};
```
